{% extends "layout.twig" %}

{% block content %}
<h2>Liste des restaurants</h2>

<input type="text" id="searchInput" placeholder="Rechercher..." style="margin-bottom:10px">

<div id="results">
    {% for r in items %}
        {{ r.name }} - {{ r.average_price }}€
        <a href="/restaurant/show?id={{ r.id }}">Détails</a>

        {% if session.user_role == 'admin' or r.created_by == session.user_id %}
            <a href="/restaurant/edit?id={{ r.id }}">Modifier</a>
            <a href="/restaurant/delete?id={{ r.id }}">Supprimer</a>
        {% endif %}

        <br>
    {% else %}
        <p>Aucun restaurant disponible.</p>
    {% endfor %}
</div>

<br>
<a href="/restaurant/create">Ajouter un restaurant</a>

<script>
const input = document.getElementById("searchInput");
const results = document.getElementById("results");

// Stockage des infos de session pour le JS
const userId = "{{ session.user_id }}";
const userRole = "{{ session.user_role }}";

input.addEventListener("input", function() {
    const q = this.value;

    fetch("/restaurant/search?q=" + encodeURIComponent(q))
        .then(res => res.json())
        .then(data => {
            results.innerHTML = "";

            if (data.length === 0) {
                results.innerHTML = "<p>Aucun résultat</p>";
                return;
            }

            data.forEach(item => {
                let html = item.name + " - " + item.average_price + "€ ";
                html += "<a href='/restaurant/show?id=" + item.id + "'>Détails</a> ";

                // Vérification des droits en JS (doit correspondre à la logique PHP/Twig)
                if (userRole === 'admin' || item.created_by == userId) {
                    html += "<a href='/restaurant/edit?id=" + item.id + "'>Modifier</a> ";
                    html += "<a href='/restaurant/delete?id=" + item.id + "'>Supprimer</a>";
                }

                html += "<br>";
                results.innerHTML += html;
            });
        });
});
</script>
{% endblock %}